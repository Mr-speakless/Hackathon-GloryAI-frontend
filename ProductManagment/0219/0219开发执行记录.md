# 0219 开发执行记录（Skin Report + Recommendation 链路）

## 1. 本次目标
- 修复并完善 `RecommendationGrid` 数据链路（Excel -> JSON -> 推荐算法 -> UI）
- 按参考图改造 `SkinReport` 风险卡展示
- 排查并修复风险卡空缺问题
- 打通前后端指标字段（补齐后端返回）

## 2. 变更总览

### 2.1 推荐链路（Excel/产品卡）

#### 文件：`scripts/export_recommendation_db.py`
- 由旧表结构映射改为新 Excel 列映射（A-H）：
  - A：图片（嵌入图，忽略文本）
  - B：brand
  - C：name
  - D：price
  - E：targetConcern
  - F：level
  - G：scoreRule（`>80` / `<80`）
  - H：productUrl
- 新增字段标准化：
  - `normalize_score_rule`
  - `normalize_level`
  - `normalize_price`
  - `get_image_file`（`{TargetConcern}-{1|2}.png`）
- 输出 JSON 字段：
  - `brand, name, price, targetConcern, level, scoreRule, imageFile, productUrl`

#### 文件：`GloryAI_frontend/src/data/productRecommendationDb.json`
- 重新导出生成新数据（8 条）
- 包含价格、图片文件名、scoreRule、产品链接

#### 文件：`GloryAI_frontend/src/utils/recommendProducts.js`
- 推荐算法从“区间匹配”改为“阈值分桶”
  - `overallScore >= 80` -> `>80`
  - `< 80` -> `<80`
- 命中桶优先，按原顺序截取前 3
- 无效分数回退前 3 条

#### 文件：`GloryAI_frontend/src/components/RecommendationGrid.jsx`
- `ProductCard` 改为纵向布局（图上文下）
- 接入图片自动映射：`import.meta.glob('../assets/images/*')`
- 支持价格格式化（数字 -> `$xx.xx`）
- 图片展示从 `object-cover` 改为 `object-contain`，避免裁切
- 长文本换行显示，保留图片缺失兜底 `No image`

---

### 2.2 SkinReport 风险卡改造

#### 文件：`GloryAI_frontend/src/components/SkinReport.jsx`
- 新增风险卡图标映射：
  - `wrinkle -> Wrinkle.svg`
  - `acne -> Acne.svg`
  - `pore -> Pores.svg`
  - `moisture -> Moisture.svg`
  - `oiliness -> Oilness.svg`
  - `redness -> Redness.svg`
  - `dark_circle_v2 -> DarkCircle.svg`
- 风险文案规则：
  - `Low + acne` -> `Good`
  - `Low + others` -> `Low Risk`
  - `Medium` -> `Medium Risk`
  - `High` -> `High Risk`
- 展示策略改造：
  - 以“有 icon 的指标”作为可展示候选
  - 计算“最好 2 + 最差 2”
- 空缺修复（关键）：
  - 早期问题：候选不足 4 时出现 `-: -` 占位
  - 现方案：
    - 候选 < 4 时不再强行补齐，不显示空占位
    - `worstLine` 为空则整行不渲染

#### 文件：`GloryAI_frontend/src/utils/skinAnalysis.js`
- `CORE_METRICS` 扩展为有 icon 的候选集合：
  - `wrinkle, acne, pore, moisture, oiliness, redness, dark_circle_v2`
- 在 `buildReport` 中新增开发期诊断日志（`import.meta.env.DEV`）：
  - 输出 `availableKeys`
  - 输出每个核心指标 `hasMetric/uiScore/isValidNumber`
  - 明确标记 `invalidKeys`

---

### 2.3 后端补齐字段（关键修复）

#### 文件：`GloryAI_backend/API/views.py`
- `DEFAULT_ACTIONS` 扩展：
  - 原：`wrinkle, pore, texture, acne`
  - 现：`wrinkle, pore, texture, acne, moisture, oiliness, redness, dark_circle_v2`
- `normalized.skin_analysis` 构建逻辑从硬编码 4 项改为动态：
  - 只要 `type` 非 `all/skin_age/resize_image` 且 `ui_score` 为数值，即写入 `skin_analysis`
- 作用：后续新增指标不再因后端硬编码被截断

## 3. 问题排查记录（关键链路）

### 3.1 风险卡空缺原因
- 诊断日志显示 `availableKeys` 仅 4 项：`pore/texture/wrinkle/acne`
- 前端候选希望展示更多指标，但后端实际未返回对应字段
- 结论：空缺根因是后端返回不完整 + 旧前端补位策略

### 3.2 纹理（texture）为何出现
- 风险卡候选中已移除 texture 时，仍可能在 summary 文案出现
- 原因：summary 来自 `topIssues` 拼接，topIssues 按后端返回全量问题排序生成

## 4. 已完成验证

### 4.1 推荐链路验证
- 导出数据条数：8
- `imageFile` 全部在 `src/assets/images` 命中
- 分桶规则验证：
  - `score=85` 返回 `>80` 桶前 3
  - `score=79` 返回 `<80` 桶前 3
  - 无效 score 回退前 3

### 4.2 语法与结构验证
- 前端核心文件已完成静态检查与交叉引用核对
- 后端 `views.py` 做了 AST 语法解析：`AST OK`
  - 注：`py_compile` 因本机 `__pycache__` 权限拒绝未采用

## 5. 当前影响文件清单
- `scripts/export_recommendation_db.py`
- `GloryAI_frontend/src/data/productRecommendationDb.json`
- `GloryAI_frontend/src/utils/recommendProducts.js`
- `GloryAI_frontend/src/components/RecommendationGrid.jsx`
- `GloryAI_frontend/src/components/SkinReport.jsx`
- `GloryAI_frontend/src/utils/skinAnalysis.js`
- `GloryAI_backend/API/views.py`

## 6. 后续建议
1. 后端联调确认 YouCam 当前账号/套餐是否稳定返回新增 action 字段。
2. 若要彻底避免“指标显示缺项感知”，可在 UI 上加入「本次返回 N 项指标」提示。
3. 若产品侧希望保持文案一致，可对 summary 的 `topIssues` 做可配置白名单过滤（与风险卡候选解耦）。
